<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Minecraft Web Launcher</title>
    <style>
        body {
            background-color: #1e1e1e;
            color: #fff;
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            border-radius: 12px;
            background: #2a2a2a;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: none;
            margin-top: 5px;
            background-color: #3a3a3a;
            color: #fff;
            font-size: 16px;
        }
        button {
            margin-top: 20px;
            padding: 12px 25px;
            background-color: #FF7F27;
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #e67322;
        }
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            min-width: 250px;
            background: #333;
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            z-index: 9999;
            opacity: 0.97;
            font-size: 16px;
            display: none;
        }
        .toast.success { background: #5cb85c; }
        .toast.error { background: #d9534f; }
        .flex-row { display: flex; gap: 10px; margin-bottom: 10px;}
        .icon-img { width: 26px; height: 26px; border-radius: 6px; vertical-align: middle; margin-right: 6px;}
    </style>
</head>
<body>
    <h1>Minecraft Web Launcher</h1>

    <div class="flex-row">
        <button id="show-available" onclick="switchList(false)">Доступные версии</button>
        <button id="show-installed" onclick="switchList(true)">Установленные</button>
    </div>

    <form id="main-form" onsubmit="return false;">
        <label for="username">Никнейм:</label>
        <input type="text" id="username" name="username" required value="{{ user_settings.get('username', '') }}" />

        <label for="memory">Память (МБ):</label>
        <input type="number" id="memory" name="memory" min="512" max="16384" step="256" value="{{ user_settings.get('memory', '') }}" />

        <label for="version_type">Тип версии:</label>
        <select id="version_type" name="version_type" onchange="loadVersions()">
            <option value="Vanilla" {% if user_settings.get('version_type') == 'Vanilla' %}selected{% endif %}>Vanilla</option>
            <option value="Forge" {% if user_settings.get('version_type') == 'Forge' %}selected{% endif %}>Forge</option>
            <option value="Fabric" {% if user_settings.get('version_type') == 'Fabric' %}selected{% endif %}>Fabric</option>
        </select>

        <label for="version">Версия:</label>
        <select id="version" name="version" size="1" style="height: 42px;">
            <!-- Динамически наполняется -->
        </select>

        <div>
            <button type="button" onclick="downloadVersion()">Скачать выбранную</button>
            <button type="button" onclick="launchVersion()">Запустить</button>
        </div>
    </form>

    <div id="toast" class="toast"></div>

    <script>
        let isInstalledList = false;
        let versionsData = [];

        function showToast(message, type="success") {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = 'toast ' + type;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3500);
        }

        function switchList(installed) {
            isInstalledList = installed;
            loadVersions();
        }

        function loadVersions() {
            const versionType = document.getElementById('version_type').value;
            fetch('/get_versions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({version_type: versionType, installed: isInstalledList})
            }).then(resp => resp.json()).then(data => {
                versionsData = data;
                const select = document.getElementById('version');
                select.innerHTML = "";
                data.forEach((v, i) => {
                    let text = v.display.replace(/ Fabric| Forge/g, '');
                    let opt = document.createElement('option');
                    opt.value = v.display;
                    opt.textContent = `${text} ${v.type}`;
                    select.appendChild(opt);
                });
                // Подставляем сохранённую версию, если есть
                const savedVersion = "{{ user_settings.get('version', '') }}";
                if (savedVersion) {
                    for (let i=0; i<select.options.length; i++) {
                        if (select.options[i].value === savedVersion) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                }
            });
        }

        function getSelectedVersion() {
            const select = document.getElementById('version');
            const idx = select.selectedIndex;
            if (idx < 0) return null;
            return versionsData[idx];
        }

        function downloadVersion() {
            const v = getSelectedVersion();
            if (!v) return showToast("Выберите версию для скачивания", "error");
            showToast("Скачивание версии...", "success");
            fetch('/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({version: v.display, vtype: v.type})
            }).then(resp => resp.json()).then(data => {
                showToast(data.message, data.status);
            });
        }

        function launchVersion() {
            const v = getSelectedVersion();
            const username = document.getElementById('username').value.trim();
            if (!username) return showToast("Введите никнейм", "error");
            if (!v) return showToast("Выберите версию для запуска", "error");
            showToast("Запуск Minecraft...", "success");
            fetch('/launch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({version: v.display, vtype: v.type, username: username})
            }).then(resp => resp.json()).then(data => {
                showToast(data.message, data.status);
            });
        }

        function saveSettings() {
            const username = document.getElementById('username').value.trim();
            const versionType = document.getElementById('version_type').value;
            const versionSelect = document.getElementById('version');
            const version = versionSelect.options[versionSelect.selectedIndex]?.value || '';
            const memory = document.getElementById('memory').value;

            fetch('/save_settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    version_type: versionType,
                    version: version,
                    memory: memory
                })
            });
        }

        // Сохраняем настройки при изменениях
        document.getElementById('username').addEventListener('change', saveSettings);
        document.getElementById('version_type').addEventListener('change', () => {
            loadVersions();
            saveSettings();
        });
        document.getElementById('version').addEventListener('change', saveSettings);
        document.getElementById('memory').addEventListener('change', saveSettings);

        window.onload = loadVersions;
    </script>
</body>
</html>
